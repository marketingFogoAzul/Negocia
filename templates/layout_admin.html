{% extends "layout_base.html" %}

{% block body_content %}
<div class="app-container">

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('admin_dashboard') }}" style="text-decoration: none;" class="ajax-link">
                <h2><i class="fas fa-cog"></i> ADMIN</h2>
            </a>
        </div>

        <div class="sidebar-nav">
            <a href="{{ url_for('new_chat_page') }}" class="btn btn-gray btn-nav-action">
                <i class="fas fa-arrow-left"></i> Voltar ao Chat
            </a>

            {% if current_user.is_authenticated and current_user.role >= 1 %}
                <h3>Admin</h3>
                <a href="{{ url_for('admin_dashboard') }}" class="ajax-link {{ 'active' if 'admin_dashboard' in request.endpoint or '/admin' == request.path }}"> {# Marca ativo para /admin também #}
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="{{ url_for('admin_my_negotiations') }}" class="ajax-link {{ 'active' if 'admin_my_negotiations' in request.endpoint }}">
                    <i class="fas fa-headset"></i> Meus Atendimentos
                </a>
                <a href="{{ url_for('admin_status') }}" class="ajax-link {{ 'active' if 'admin_status' in request.endpoint }}">
                    <i class="fas fa-server"></i> Status ZIP Negocia
                </a>

                {% if current_user.can('promote_to_junior') %}
                <a href="{{ url_for('admin_users') }}" class="ajax-link {{ 'active' if 'admin_users' in request.endpoint }}">
                    <i class="fas fa-users-cog"></i> Gerenciar Usuários
                </a>
                <a href="{{ url_for('admin_filters') }}" class="ajax-link {{ 'active' if 'admin_filters' in request.endpoint }}">
                    <i class="fas fa-robot"></i> Filtrar IA
                </a>
                <a href="{{ url_for('admin_webrtc') }}" class="ajax-link {{ 'active' if 'admin_webrtc' in request.endpoint }}">
                    <i class="fas fa-phone-alt"></i> WebRTC Config
                </a>
                {% endif %}

                {% if current_user.can('insert_product') %}
                <a href="{{ url_for('admin_products') }}" class="ajax-link {{ 'active' if 'admin_products' in request.endpoint }}">
                    <i class="fas fa-box-open"></i> Editar Itens
                </a>
                {% endif %}

                {% if current_user.can('view_all_negotiations') %}
                <a href="{{ url_for('admin_negotiations') }}" class="ajax-link {{ 'active' if 'admin_negotiations' in request.endpoint }}">
                    <i class="fas fa-history"></i> Histórico de Conversas
                </a>
                {% endif %}

                {% if current_user.can('view_general_attendance') %}
                <a href="{{ url_for('admin_all_negotiations') }}" class="ajax-link {{ 'active' if 'admin_all_negotiations' in request.endpoint }}">
                    <i class="fas fa-sitemap"></i> Atendimentos (Geral)
                </a>
                {% endif %}

                {% if current_user.can('view_logs') %}
                 <a href="{{ url_for('admin_logs') }}" class="ajax-link {{ 'active' if 'admin_logs' in request.endpoint }}">
                    <i class="fas fa-clipboard-list"></i> Logs de Auditoria
                </a>
                {% endif %}

                {# --- NOVA SECÇÃO --- #}
                <h3>Comunicação Interna</h3>
                {# Link Visível para Todos os Admins (1-5) #}
                <a href="{{ url_for('internal_chat', chat_room='avisos') }}" class="ajax-link {{ 'active' if request.endpoint == 'internal_chat' and chat_room == 'avisos' }}">
                    <i class="fas fa-bullhorn"></i> Avisos
                </a>
                {# Link Visível para Todos os Admins (1-5) #}
                 <a href="{{ url_for('internal_chat', chat_room='geral') }}" class="ajax-link {{ 'active' if request.endpoint == 'internal_chat' and chat_room == 'geral' }}">
                    <i class="fas fa-users"></i> Chat Geral (Admins)
                </a>
                {# Link Visível Apenas para 3, 4, 5 #}
                {% if current_user.role >= 3 %}
                 <a href="{{ url_for('internal_chat', chat_room='adm') }}" class="ajax-link {{ 'active' if request.endpoint == 'internal_chat' and chat_room == 'adm' }}">
                    <i class="fas fa-user-shield"></i> Chat Adm (Restrito)
                </a>
                {% endif %}
                 {# --- FIM NOVA SECÇÃO --- #}

            {% endif %}
        </div>

        <div class="sidebar-footer">
            {% if current_user.is_authenticated %}
            <div class="sidebar-user">
                <div class="user-avatar">
                    {{ current_user.name[0]|upper }}
                </div>
                <div class="user-info">
                    <div class="user-name">{{ current_user.name }}</div>
                    <div class="user-role-link" style="cursor: default; color: var(--color-text-muted);">
                        {% if current_user.role == 1 %}Vendedor
                        {% elif current_user.role == 2 %}Teste
                        {% elif current_user.role == 3 %}MKT/TI
                        {% elif current_user.role == 4 %}Junior
                        {% elif current_user.role == 5 %}Dev
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="sidebar-footer-links">
                <a href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="main-content" id="main-content-ajax">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mainContent = document.getElementById('main-content-ajax');
        const sidebarNav = document.querySelector('.sidebar-nav');

        // Função para executar scripts dentro do HTML carregado via AJAX
        function executeScripts(containerElement) {
            const scripts = containerElement.querySelectorAll('script');
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                if (script.src) {
                    newScript.src = script.src;
                    newScript.async = false; // Garante execução sequencial se houver dependências
                    document.body.appendChild(newScript);
                    newScript.onload = () => { /*console.log('Script loaded:', script.src);*/ }; // Feedback opcional
                    newScript.onerror = () => { console.error('Error loading script:', script.src); };
                } else {
                    newScript.textContent = script.textContent;
                     document.body.appendChild(newScript);
                }
                // Não removemos o script original do container, pois ele não será executado
                // pelo navegador ao ser injetado via innerHTML. Apenas o newScript será.
            });
        }

        // Função para carregar conteúdo via AJAX
        async function loadContent(url, pushState = true) {
            // Adiciona um indicador visual de loading (opcional)
            mainContent.style.opacity = '0.5';
            mainContent.style.pointerEvents = 'none'; // Impede interação durante o loading

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Cabeçalho essencial
                    }
                });

                if (!response.ok) {
                    // Tenta obter mensagem de erro do corpo, se houver
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    let errorDetails = ''; // Para detalhes adicionais
                    const contentType = response.headers.get('content-type');

                    if (contentType && contentType.includes('application/json')) {
                         try {
                             const errorData = await response.json();
                             errorMsg = errorData.message || `Erro ${response.status}`;
                         } catch (e) { /* Ignora erro de parsing JSON */ }
                    } else {
                         // Se for HTML (página de erro do Flask/Werkzeug) ou texto
                         errorDetails = await response.text();
                         const match = errorDetails.match(/<title>(.*?)<\/title>/i);
                         if (match && match[1]) {
                             errorMsg = match[1]; // Ex: "403 Forbidden"
                         } else {
                              // Se não encontrar título, usa o início do texto como fallback
                             errorMsg = errorDetails.substring(0, 150).replace(/<[^>]+>/g, ' ').trim() || errorMsg;
                         }
                         console.error('AJAX Error Response Body:', errorDetails); // Log completo para debug
                    }
                    throw new Error(errorMsg);
                }

                const html = await response.text();
                // Limpa o conteúdo anterior ANTES de adicionar o novo
                mainContent.innerHTML = '';
                // Cria um container temporário para inserir o HTML e extrair elementos
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                // Move os filhos do tempDiv (o conteúdo real) para o mainContent
                while (tempDiv.firstChild) {
                    mainContent.appendChild(tempDiv.firstChild);
                }

                // Tenta encontrar o título DENTRO do HTML carregado (se o template parcial o incluir)
                 const titleElement = mainContent.querySelector('title'); // Procura por <title> no conteúdo carregado
                 let pageTitle = "Admin Panel"; // Título padrão
                 if (titleElement) {
                     pageTitle = titleElement.textContent.trim();
                     titleElement.remove(); // Remove o <title> do conteúdo principal
                 } else {
                      // Tenta obter o título do link clicado como fallback
                     const activeLink = sidebarNav.querySelector(`a.ajax-link[href="${url.split('?')[0]}"]`);
                     if (activeLink) {
                         pageTitle = activeLink.textContent.trim().replace(/^[ \n]+|[ \n]+$/g, '').replace(/\s+/g, ' '); // Limpa whitespace
                         if (pageTitle) pageTitle += " - Admin";
                     }
                 }
                 document.title = pageTitle;

                // Atualiza a URL na barra de endereço
                if (pushState) {
                    history.pushState({ path: url }, '', url);
                }

                // Atualiza a classe 'active' na sidebar
                updateActiveLink(url);

                 // Executa quaisquer scripts que possam estar no bloco scripts do HTML carregado
                executeScripts(mainContent); // Chama a função para executar scripts


            } catch (error) {
                console.error('Erro ao carregar conteúdo via AJAX:', error);
                mainContent.innerHTML = `<div class="admin-header" style="background-color: var(--color-danger); color: white;">
                                            <h1>Erro ao Carregar</h1>
                                         </div>
                                         <div class="admin-content">
                                             <p style="color: var(--color-text-primary);">Não foi possível carregar a secção solicitada.</p>
                                             <p style="color: var(--color-text-muted); font-size: 0.9em;">Detalhe: ${error.message}</p>
                                             <p><a href="${url}" target="_blank">Tentar abrir numa nova aba</a></p>
                                         </div>`;
            } finally {
                 mainContent.style.opacity = '1'; // Remove o loading
                 mainContent.style.pointerEvents = 'auto'; // Reabilita interação
                 // Remove flash messages antigas (se houver) que NÃO estão dentro do mainContent
                 const globalFlashes = document.querySelector('.flash-messages:not(#main-content-ajax .flash-messages)');
                 if (globalFlashes) {
                    // globalFlashes.remove(); // Descomentar se quiser remover flashes globais a cada navegação
                 }
            }
        }

        // Função para atualizar o link ativo na sidebar
        function updateActiveLink(url) {
            const currentPath = url.split('?')[0]; // Ignora query parameters
            sidebarNav.querySelectorAll('a.ajax-link').forEach(link => {
                 // Trata o caso especial de /admin ser o mesmo que /admin/dashboard
                 const linkPath = link.getAttribute('href');
                 let isActive = linkPath === currentPath;
                 // Se a URL atual é /admin E o link é /admin/dashboard, marca ativo
                 if (currentPath === '{{ url_for("admin_dashboard", _external=False) }}'.replace('/dashboard', '') && linkPath === '{{ url_for("admin_dashboard", _external=False) }}') {
                     isActive = true;
                 }
                  // Se a URL atual é /admin/dashboard E o link é /admin (caso exista), marca ativo
                 if (currentPath === '{{ url_for("admin_dashboard", _external=False) }}' && linkPath === '{{ url_for("admin_dashboard", _external=False) }}'.replace('/dashboard', '')) {
                      isActive = true;
                 }


                if (isActive) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        // Intercepta cliques nos links da sidebar com a classe 'ajax-link'
        sidebarNav.addEventListener('click', function(event) {
            const link = event.target.closest('a.ajax-link');
            if (link) {
                event.preventDefault(); // Impede a navegação normal
                const url = link.getAttribute('href');
                const currentFullUrl = window.location.pathname + window.location.search;
                if (url !== currentFullUrl && url !== window.location.pathname ) { // Evita recarregar a mesma página
                     loadContent(url);
                }
            }
        });

        // Lida com os botões de voltar/avançar do navegador
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.path) {
                // Carrega o conteúdo do estado anterior sem adicionar ao histórico
                loadContent(event.state.path, false);
            } else {
                 // Fallback: carrega o dashboard se não houver estado
                 const dashboardUrl = '{{ url_for("admin_dashboard") }}';
                 // Evita recarregar se já estiver no dashboard
                 if (window.location.pathname !== dashboardUrl && window.location.pathname !== dashboardUrl.replace('/dashboard', '')) {
                      loadContent(dashboardUrl, false);
                 }
            }
        });

        // Adiciona o estado inicial ao histórico para o botão voltar funcionar corretamente
        history.replaceState({ path: window.location.pathname + window.location.search }, '', window.location.pathname + window.location.search);
        updateActiveLink(window.location.pathname); // Marca o link ativo inicial

        // Delegação de eventos para formulários carregados via AJAX (Exemplo para busca)
        // Isso garante que formulários carregados dinamicamente também funcionem com AJAX (se desejado)
        mainContent.addEventListener('submit', async function(event) {
            const form = event.target.closest('.search-form'); // Adapte o seletor se necessário
            if (form && form.method.toLowerCase() === 'get') { // Apenas para GET por enquanto
                event.preventDefault();
                const formData = new FormData(form);
                const searchParams = new URLSearchParams(formData);
                const url = form.action + '?' + searchParams.toString();
                loadContent(url); // Recarrega o conteúdo com os parâmetros de busca
            }
            // Adicionar lógica para POST se necessário (mais complexo)
        });

        // Tenta executar scripts que já possam estar no conteúdo inicial
        executeScripts(mainContent);


    });
</script>
{% endblock %}