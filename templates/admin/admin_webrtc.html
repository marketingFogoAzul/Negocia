{% extends base_template | default("layout_admin.html") %}

{% block title %}Configurações WebRTC{% endblock %}
{% block body_class %}admin-layout{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Configurações WebRTC</h1>
    <p>Ative ou desative funcionalidades de chamada para utilizadores e administradores.</p>
</div>

<div class="admin-content">
    <div class="admin-section">
        <h2>Funcionalidades WebRTC</h2>
        <table class="admin-table webrtc-table">
            <thead>
                <tr>
                    <th>Funcionalidade</th>
                    <th>Acesso Utilizador</th>
                    <th>Acesso Admin</th>
                </tr>
            </thead>
            <tbody>
                {% for feature in features %}
                <tr data-feature-id="{{ feature.id }}">
                    <td><strong>{{ feature.name }}</strong></td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" class="webrtc-toggle" data-access="user" {{ 'checked' if feature.user_enabled else '' }}>
                            <span class="slider round"></span>
                        </label>
                    </td>
                    <td>
                        <label class="switch">
                            <input type="checkbox" class="webrtc-toggle" data-access="admin" {{ 'checked' if feature.admin_enabled else '' }}>
                            <span class="slider round"></span>
                        </label>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
         <p style="margin-top: 15px; font-size: 0.85rem; color: var(--color-text-muted);">
            Nota: Funcionalidades como "Toque de Chamada", "Cancelar" e "Mutar" são parte integrante das chamadas e não necessitam de ativação separada aqui.
        </p>
    </div>
</div>
{% endblock content %}

{% block scripts %}
{# Este script será extraído e executado pelo JS em layout_admin.html #}
<script>
    // Usa um IIFE para evitar conflitos de variáveis globais
    (function() {
        // Define a função para anexar listeners no escopo local
        function attachWebRTCToggleListeners() {
            const mainContent = document.getElementById('main-content-ajax');
            if (!mainContent) return; // Sai se o container principal não for encontrado

            mainContent.querySelectorAll('.webrtc-toggle').forEach(toggle => {
                // Verifica se já existe um listener (para evitar duplicação)
                if (toggle.dataset.listenerAttached === 'true') {
                    // console.log('Listener já anexado para:', toggle.closest('tr').dataset.featureId, toggle.dataset.access);
                    return;
                }
                toggle.dataset.listenerAttached = 'true'; // Marca como tendo listener
                // console.log('Anexando listener para:', toggle.closest('tr').dataset.featureId, toggle.dataset.access);


                toggle.addEventListener('change', async (event) => {
                    const checkbox = event.target;
                    const featureId = checkbox.closest('tr').dataset.featureId;
                    const accessType = checkbox.dataset.access;
                    const isEnabled = checkbox.checked;

                    // Desabilita temporariamente para evitar cliques múltiplos
                    checkbox.disabled = true;
                    const label = checkbox.closest('label');
                    if(label) label.style.opacity = '0.5'; // Feedback visual

                    try {
                        const response = await fetch('/api/admin/webrtc/toggle', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                feature_id: featureId,
                                access_type: accessType,
                                enabled: isEnabled
                            })
                        });
                        const result = await response.json();

                        if (!response.ok || !result.success) {
                             const errorMsg = result.message || `Erro ${response.status} ao atualizar.`;
                            alert('Erro: ' + errorMsg);
                            // Reverte a alteração visual em caso de erro
                            checkbox.checked = !isEnabled;
                        } else {
                            // Feedback visual de sucesso (opcional)
                            console.log(result.message); // Apenas log por enquanto
                            const row = checkbox.closest('tr');
                            if (row) {
                                 row.style.backgroundColor = 'rgba(16, 185, 129, 0.1)'; // Verde suave
                                 setTimeout(() => { row.style.backgroundColor = ''; }, 1000); // Remove após 1s
                            }
                        }
                    } catch (err) {
                         console.error("Erro no toggle WebRTC:", err);
                        alert('Erro de conexão ao atualizar a configuração.');
                        checkbox.checked = !isEnabled; // Reverte
                    } finally {
                        checkbox.disabled = false; // Reabilita
                         if(label) label.style.opacity = '1';
                    }
                });
            });
         } // Fim de attachWebRTCToggleListeners

         // Chama a função imediatamente para anexar listeners ao conteúdo carregado
         attachWebRTCToggleListeners();
         console.log("Scripts for admin_webrtc loaded and listeners attached.");

    })(); // Executa a função imediatamente
</script>
{% endblock scripts %}