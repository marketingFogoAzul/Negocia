{% extends base_template | default("layout_admin.html") %}

{% block title %}{{ room_title }}{% endblock %}
{% block body_class %}admin-layout{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>{{ room_title }}</h1>
    <p>Chat interno para administradores.</p>
</div>

<div class="admin-content">
    <div class="chat-container" style="height: calc(100vh - 150px); display: flex; flex-direction: column; background-color: var(--color-bg-secondary); border: 1px solid var(--color-border); border-radius: 8px;"> {# Estilo container #}
        
        {# Área de Mensagens (Placeholder) #}
        <div class="chat-window" id="internal-chat-window" style="flex: 1; overflow-y: auto; padding: 15px; background-color: var(--color-bg-primary);">
            {% if messages %}
                {# Loop pelas mensagens viria aqui - Exemplo de estrutura #}
                 {% for msg in messages %}
                     <div class="message-container {{ 'user' if msg.sender_id == current_user.id else 'admin' }}" style="max-width: 95%;"> {# Ajusta largura #}
                        <div class="message-content">
                             <div class="message-sender-name">{{ msg.sender_name }} ({{ msg.timestamp.strftime('%H:%M') }})</div>
                            <div class="message-bubble" style="{{ 'align-self: flex-end; background-color: var(--color-primary); color: white;' if msg.sender_id == current_user.id else '' }}">
                                {{ msg.text | replace('\n', '<br>') | safe }}
                            </div>
                        </div>
                    </div>
                 {% endfor %}
            {% else %}
                <div class="message-container system">
                    <div class="message-bubble">Bem-vindo ao {{ room_title }}. Nenhuma mensagem ainda.</div>
                </div>
            {% endif %}
        </div>

        {# Área de Input (Placeholder) #}
        <div class="chat-input-area" id="internal-input-area" style="background-color: var(--color-bg-secondary);">
            {% if can_write %}
            <div class="chat-input-row">
                <textarea id="internal-chat-input" placeholder="Digite sua mensagem..." rows="1" style="max-height: 100px;"></textarea>
                <button id="internal-send-button" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            {% else %}
             <div class="text-center text-muted" style="padding: 10px;">
                <i class="fas fa-lock"></i> Você apenas pode ler as mensagens neste canal.
             </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
{# JavaScript para enviar/receber mensagens via SocketIO viria aqui no futuro #}
<script>
    // Usa IIFE
    (function() {
        const chatWindowInternal = document.getElementById('internal-chat-window');
        const sendBtnInternal = document.getElementById('internal-send-button');
        const inputInternal = document.getElementById('internal-chat-input');

        // Placeholder para scroll
        if(chatWindowInternal) {
            chatWindowInternal.scrollTop = chatWindowInternal.scrollHeight;
             // Auto-resize para textarea (copiado do chat.js)
             function autoResizeTextareaInternal(textarea) {
                if (!textarea) return;
                textarea.style.height = 'auto';
                textarea.style.height = Math.max(42, textarea.scrollHeight) + 'px';
             }
             if(inputInternal){
                 autoResizeTextareaInternal(inputInternal); // Ajusta no load
                 inputInternal.addEventListener('input', () => autoResizeTextareaInternal(inputInternal));
             }
        }

        // Placeholder para botão enviar
        if(sendBtnInternal && inputInternal) { // Verifica se ambos existem
            const sendMessageInternal = () => {
                 if (inputInternal.value.trim() !== '') {
                      alert('Placeholder: Enviar mensagem para {{ chat_room }}: ' + inputInternal.value);
                      // Lógica de envio via SocketIO iria aqui
                      // Ex: socket.emit('send_internal_message', { room: '{{ chat_room }}', text: inputInternal.value });
                      inputInternal.value = '';
                      autoResizeTextareaInternal(inputInternal); // Reseta altura
                 }
            };

            sendBtnInternal.addEventListener('click', sendMessageInternal);

             inputInternal.addEventListener('keydown', (e) => {
                 if (e.key === 'Enter' && !e.shiftKey) {
                     e.preventDefault();
                     sendMessageInternal();
                 }
             });
        }
        // Placeholder para receber mensagens via SocketIO
        // Ex: if (typeof io !== 'undefined') {
        //         const socket = io(); // Conectar ao SocketIO
        //         socket.emit('join_internal_room', { room: '{{ chat_room }}' });
        //         socket.on('receive_internal_message', (msg) => {
        //              console.log('Nova msg interna:', msg);
        //              // Adicionar msg ao chatWindowInternal e fazer scroll
        //         });
        //     }

        console.log("Scripts for internal_chat ({{ chat_room }}) loaded.");

    })(); // Executa
</script>
{% endblock scripts %}