{% extends base_template | default("layout_admin.html") %}

{% block title %}Histórico de Conversas{% endblock %}
{% block body_class %}admin-layout{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Histórico de Conversas</h1>
    <p>Visualize todos os chats do sistema (Cargos 2+).</p>
</div>

<div class="admin-content">

    <div class="admin-section">
         {# Formulário de busca tratado via JS #}
        <form method="GET" action="{{ url_for('admin_negotiations') }}" class="search-form">
            <div class="form-group" style="grid-column: 1 / 3;">
                <label for="q">Buscar (Cliente, Vendedor ou ID do Chat)</label>
                <input type="search" id="q" name="q" value="{{ search_query | default('', true) }}" placeholder="Digite o termo...">
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Buscar</button>
        </form>
    </div>

    <div class="admin-section">
        {% if negotiations %}
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID Chat</th>
                    <th>Cliente</th>
                    <th>Produto</th>
                    <th>Vendedor</th>
                    <th>Status</th>
                    <th>Data</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                {% for chat in negotiations %}
                <tr>
                    <td>#{{ chat.id }}</td>
                    <td>{{ chat.user_name }}<br><small>{{ chat.user_email }}</small></td>
                    <td>{{ chat.product_name | default('N/A') }}</td>
                    <td>{{ chat.assigned_admin | default('N/A') }}</td>
                    <td><span class="status-{{chat.status}}">{{ chat.status | replace('_', ' ') }}</span></td> {# Formata status #}
                    <td style="white-space: nowrap;">{{ chat.created_at.strftime('%d/%m/%Y %H:%M') if chat.created_at else 'N/A' }}</td> {# Verifica se existe #}
                    <td>
                        {# Link para chat existente NÃO deve ser AJAX #}
                        <a href="{{ url_for('existing_chat_page', chat_id=chat.id) }}" class="btn btn-sm btn-gray">
                            Ver Histórico
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Nenhuma negociação encontrada com esse critério.</p>
        {% endif %}
    </div>
</div>
{% endblock content %}

{% block scripts %}
{# Sem scripts específicos para esta página por enquanto #}
{% endblock scripts %}