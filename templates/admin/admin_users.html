{% extends "layout.html" %}
{% block title %}Gerenciar Usuários{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Gerenciar Usuários e Cargos</h1>
    <p>Promova ou rebaixe usuários do sistema.</p>
</div>

<div class="admin-content">
    {% if dev_activated %}
    <div class="flash info">
        <b>Aviso:</b> O cargo de Desenvolvedor (5) já foi ativado e está oculto.
    </div>
    {% endif %}

    {% if users is not none and users %}
    <table class="admin-table" id="users-table">
        <thead>
            <tr>
                <th>Nome</th>
                <th>E-mail</th>
                <th>Cargo Atual</th>
                <th>Novo Cargo</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr data-id="{{ user.id }}">
                <td>{{ user.name }}</td>
                <td>{{ user.email }}</td>
                <td>
                    {% if user.role == 0 %}
                        Consumidor
                    {% elif user.role == 1 %}
                        Vendedor
                    {% elif user.role == 2 %}
                        Teste
                    {% elif user.role == 3 %}
                        MKT/TI
                    {% elif user.role == 4 %}
                        Junior
                    {% elif user.role == 5 %}
                        Desenvolvedor
                    {% else %}
                        Desconhecido
                    {% endif %}
                    ({{ user.role }})
                </td>
                <td>
                    <select class="role-select" data-userid="{{ user.id }}">
                        {% for i in range(current_user.role) %}
                            <option value="{{ i }}" {{ 'selected' if i == user.role else '' }}>
                                {% if i == 0 %}
                                    Consumidor
                                {% elif i == 1 %}
                                    Vendedor
                                {% elif i == 2 %}
                                    Teste
                                {% elif i == 3 %}
                                    MKT/TI
                                {% elif i == 4 %}
                                    Junior
                                {% else %}
                                    Cargo {{ i }}
                                {% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </td>
                <td class="actions">
                    <button class="btn btn-sm btn-primary" onclick="promoteUser({{ user.id }})">
                        Salvar Cargo
                    </button>
                    <a href="{{ url_for('admin_negotiations', q=user.email) }}" class="btn btn-sm btn-gray">
                        Ver Chamados
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
         <p>Nenhum usuário para gerenciar (ou todos têm cargo igual/superior ao seu).</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    async function promoteUser(userId) {
        const row = document.querySelector(`tr[data-id="${userId}"]`);
        const select = row.querySelector('.role-select');
        const button = row.querySelector('button');
        const newRole = select.value;
        
        button.disabled = true;
        button.textContent = '...';

        try {
            const response = await fetch('/api/admin/users/promote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId, newRole: newRole })
            });
            const result = await response.json();
            alert(result.message);
            if (response.ok) {
                // Atualiza o texto do cargo
                const roleText = row.querySelector('td:nth-child(3)');
                const roleNames = {
                    '0': 'Consumidor',
                    '1': 'Vendedor', 
                    '2': 'Teste',
                    '3': 'MKT/TI',
                    '4': 'Junior',
                    '5': 'Desenvolvedor'
                };
                roleText.textContent = `${roleNames[newRole]} (${newRole})`;
            }
        } catch (err) {
            alert('Erro de conexão.');
        } finally {
            button.disabled = false;
            button.textContent = 'Salvar Cargo';
        }
    }
</script>
{% endblock %}