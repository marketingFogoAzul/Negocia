{% extends base_template | default("layout_admin.html") %}

{% block title %}Gerenciar Produtos{% endblock %}
{% block body_class %}admin-layout{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Gerenciar Produtos (Itens)</h1>
    <p>Adicione, remova ou edite produtos do sistema.</p>
</div>

<div class="admin-content">
    <div class="admin-section">
        <h2>Adicionar Novo Produto</h2>
        <form class="admin-form" id="add-product-form">
            <div class="form-group">
                <label for="code">Código (SKU)</label>
                <input type="text" id="code" required>
            </div>
            <div class="form-group">
                <label for="name">Nome do Produto</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="price">Preço (ex: 1800.00)</label>
                <input type="number" id="price" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="stock">Estoque</label>
                <input type="number" id="stock" step="1" min="0" required>
            </div>
            <div class="form-group full-width">
                <label for="colors">Cores (separadas por vírgula)</label>
                <input type="text" id="colors" placeholder="Preto, Vermelho, Azul">
            </div>
            <p class="error-message full-width" id="add-product-error"></p> {# Adicionado ID #}
            <button type="submit" class="btn btn-primary">Adicionar Produto</button>
        </form>
    </div>

    <div class="admin-section">
        <h2>Produtos Cadastrados</h2>
        {# Formulário de busca tratado via JS #}
        <form method="GET" action="{{ url_for('admin_products') }}" class="search-form">
            <div class="form-group" style="grid-column: 1 / 3;">
                <label for="q">Buscar (Nome ou Código)</label>
                <input type="search" id="q" name="q" value="{{ search_query | default('', true) }}" placeholder="Digite o termo...">
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Buscar</button>
        </form>

        {% if products %}
        <table class="admin-table" id="products-table">
            <thead>
                <tr>
                    <th>Código (SKU)</th>
                    <th>Nome</th>
                    <th>Preço</th>
                    <th>Estoque</th>
                    <th>Cores</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr data-id="{{ product.id }}">
                    <td>{{ product.code }}</td>
                    <td>{{ product.name }}</td>
                    <td>R$ {{ "%.2f"|format(product.price) }}</td>
                    <td>{{ product.stock }}</td>
                    <td>{{ product.colors | join(', ') if product.colors else 'N/A' }}</td>
                    <td>
                        {% if current_user.can('remove_product') %}
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct({{ product.id }}, this)">
                            Remover
                        </button>
                        {% endif %}
                        </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>Nenhum produto cadastrado (ou encontrado na busca).</p>
        {% endif %}
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
    // Usa IIFE para escopo local e executa imediatamente
    (function() {
        const addForm = document.getElementById('add-product-form');
        const errorMsgElement = document.getElementById('add-product-error'); // Usa ID

        if (addForm && errorMsgElement) {
            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = addForm.querySelector('button[type="submit"]');
                 if (!button) return;

                button.disabled = true;
                button.textContent = 'Salvando...';
                errorMsgElement.textContent = ''; // Limpa erro

                const data = {
                    code: document.getElementById('code').value,
                    name: document.getElementById('name').value,
                    price: document.getElementById('price').value,
                    stock: document.getElementById('stock').value,
                    colors: document.getElementById('colors').value,
                };

                try {
                    const response = await fetch('/api/admin/products', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();

                    if (response.ok) {
                        alert(result.message || 'Produto adicionado!');
                         // Recarrega o conteúdo via AJAX
                         if (typeof loadContent === 'function') {
                             loadContent(window.location.pathname + window.location.search, false);
                         } else {
                             window.location.reload();
                         }
                    } else {
                        errorMsgElement.textContent = result.message || 'Erro desconhecido.';
                         button.disabled = false; // Reabilita em caso de erro
                         button.textContent = 'Adicionar Produto';
                    }
                } catch (err) {
                    console.error("Erro ao adicionar produto:", err);
                    errorMsgElement.textContent = 'Erro de conexão.';
                    button.disabled = false;
                    button.textContent = 'Adicionar Produto';
                }
            });
        }

        // Define a função deleteProduct no escopo local
        async function deleteProduct(productId, element) {
            if (!confirm('Tem certeza que deseja remover este produto?')) {
                return;
            }
             if (!element) return;

            element.disabled = true;
            element.textContent = '...';
            const originalText = 'Remover';

            try {
                const response = await fetch(`/api/admin/products/${productId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (response.ok) {
                    alert(result.message || 'Produto removido.');
                    const row = element.closest('tr');
                     if (row) row.remove(); // Remove a linha
                } else {
                    alert('Erro: ' + (result.message || 'Não foi possível remover.'));
                    element.disabled = false;
                    element.textContent = originalText;
                }
            } catch (err) {
                 console.error("Erro ao remover produto:", err);
                alert('Erro de conexão.');
                element.disabled = false;
                element.textContent = originalText;
            }
        }

        // Anexa a função ao window SOMENTE se ela não existir
         if (typeof window.deleteProduct !== 'function') {
             window.deleteProduct = deleteProduct;
         }

        console.log("Scripts for admin_products loaded.");

    })(); // Executa a função imediatamente
</script>
{% endblock scripts %}