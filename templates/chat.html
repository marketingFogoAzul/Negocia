{% extends "layout_chat.html" %} {% block title %}Chat de Negociação{% endblock %}
{# body_class removido daqui pois está no layout_chat #}

{% block content %}
<div class="chat-container">

    <div class="chat-header" id="chat-header" {% if not chat_id %}class="hidden"{% endif %}>
        <div class="chat-header-info">
            <h3>Negociação #<span id="chat-header-id">{{ chat_id | default('Nova', true) }}</span></h3>
            <span class="chat-status" id="chat-status">
                {% if chat_data and chat_data.status == 'completed' %}
                    Negociação Encerrada
                {% elif chat_data and chat_data.status == 'pending_review' %}
                    Aguardando revisão
                {% elif chat_data and chat_data.status == 'assumed' %}
                    Em atendimento
                {% elif chat_data and chat_data.status == 'manual_override' %}
                    IA Desativada - Atendimento Manual
                {% else %}
                    Negociação em andamento
                {% endif %}
            </span>
        </div>
        <div class="chat-actions">
            {% if current_user.is_authenticated and current_user.role >=1 %} {# Só mostra botões admin se for admin #}
            <button class="btn btn-sm btn-warning hidden" id="disable-ia-button">
                Desativar IA
            </button>
            <button class="btn btn-sm btn-danger hidden" id="close-chat-button">
                Encerrar Negociação
            </button>
            {% endif %}
        </div>
    </div>

    <div class="chat-window" id="chat-window">

        {% if chat_history %}
            {% for msg in chat_history %}
                {% if msg.sender_type == 'system' %}
                    <div class="message-container system">
                        <div class="message-bubble">{{ msg.text }}</div>
                    </div>
                {% else %}
                    <div class="message-container {{ msg.sender_type }}">
                        <div class="message-content">
                            {% if msg.sender_type == 'admin' %}
                                <div class="message-sender-name">{{ msg.sender_name | default('Vendedor', true) }}</div>
                            {% elif msg.sender_type == 'user' %}
                                <div class="message-sender-name">{{ chat_data.user_name if chat_data else current_user.name }}</div> {# Corrigido para mostrar nome correto #}
                            {% endif %}

                            <div class="message-bubble">
                                {{ msg.text | replace('\n', '<br>') | safe }}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>

    <div class="chat-input-area" id="input-area">

        {# Botão só aparece para user (role 0) e se chat_id existir #}
        {% if current_user.is_authenticated and current_user.role == 0 and chat_id %}
        <div class="hidden" id="review-button-container">
            <button id="review-button" class="btn btn-warning">
                <i class="fas fa-gavel"></i> Solicitar Revisão da Proposta
            </button>
        </div>
        {% endif %}

        <div class="chat-input-row" id="chat-input-row">
            <textarea id="chat-input" placeholder="Digite sua mensagem..." rows="1"></textarea>
            <button id="send-button" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
    {# Script do chat agora é carregado aqui #}
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
    <script>
        // Passa os dados do Python (Flask) para o JavaScript (ChatModule)
        ChatModule.init({
            chatId: {{ chat_id | tojson }},
            status: "{{ chat_data.status | default('active', true) if chat_data else 'active' }}", {# Default status if no chat_data #}
            reviewRequested: {{ chat_data.review_requested | default(false) | tojson if chat_data else 'false' }}, {# Default if no chat_data #}
            userName: "{{ current_user.name }}",
            userRole: {{ current_user.role | default(0) }}
        });

        // Auto-resize do textarea (movido para chat.js init para garantir execução)
    </script>
{% endblock %}